name: Daily First Filings Run

on:
  schedule:
    - cron: '30 21 * * *'
  workflow_dispatch:
    inputs:
      date:
        description: 'Date (DD-MM-YYYY or YYYY-MM-DD)'
        required: false
        type: string
      skip_wait:
        description: 'Skip 30 min wait?'
        type: boolean
        required: false
        default: false

jobs:
  run-daily:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        run: uv python install

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Run first-filings BSE
        run: |
          ARGS="--exchange bse"
          if [ -n "${{ inputs.date }}" ]; then
            ARGS="$ARGS --date ${{ inputs.date }}"
          fi
          uv run first-filings $ARGS

      - name: Upload Output JSON BSE
        uses: actions/upload-artifact@v4
        with:
          name: bse-output
          path: bse_output.json
          retention-days: 1
      
      - name: Send BSE Output to Discord
        run: uv run --with requests python scripts/send_discord_webhook.py bse_output.json
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        continue-on-error: true

      - name: Run first-filings NSE Main
        run: |
          ARGS="--exchange nse-main"
          if [ -n "${{ inputs.date }}" ]; then
            ARGS="$ARGS --date ${{ inputs.date }}"
          fi
          uv run first-filings $ARGS

      - name: Upload Output JSON NSE Main
        uses: actions/upload-artifact@v4
        with:
          name: nse-main-output
          path: nse_main_output.json
          retention-days: 1

      - name: Send NSE Main Output to Discord
        run: uv run --with requests python scripts/send_discord_webhook.py nse_main_output.json
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        continue-on-error: true

      - name: Wait for 30 minutes
        if: ${{ github.event_name == 'schedule' || inputs.skip_wait != 'true' }}
        run: sleep 1800

      - name: Run first-filings NSE SME
        run: |
          ARGS="--exchange nse-sme"
          if [ -n "${{ inputs.date }}" ]; then
            ARGS="$ARGS --date ${{ inputs.date }}"
          fi
          uv run first-filings $ARGS

      - name: Upload Output JSON NSE SME
        uses: actions/upload-artifact@v4
        with:
          name: nse-sme-output
          path: nse_sme_output.json
          retention-days: 1

      - name: Send NSE SME Output to Discord
        run: uv run --with requests python scripts/send_discord_webhook.py nse_sme_output.json
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        continue-on-error: true
